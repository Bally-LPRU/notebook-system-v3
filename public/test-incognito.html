<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏ó‡∏î‡∏™‡∏≠‡∏ö Incognito Mode</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      border-radius: 8px;
      padding: 30px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      border-bottom: 3px solid #4CAF50;
      padding-bottom: 10px;
    }
    .test-section {
      margin: 20px 0;
      padding: 20px;
      background: #f9f9f9;
      border-left: 4px solid #2196F3;
      border-radius: 4px;
    }
    .test-section h2 {
      margin-top: 0;
      color: #2196F3;
    }
    .status {
      display: inline-block;
      padding: 5px 15px;
      border-radius: 20px;
      font-weight: bold;
      margin: 5px 0;
    }
    .status.pass {
      background: #4CAF50;
      color: white;
    }
    .status.fail {
      background: #f44336;
      color: white;
    }
    .status.pending {
      background: #FF9800;
      color: white;
    }
    button {
      background: #2196F3;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 5px;
    }
    button:hover {
      background: #1976D2;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .log {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      max-height: 400px;
      overflow-y: auto;
      margin: 10px 0;
    }
    .log-entry {
      margin: 5px 0;
      padding: 5px;
      border-left: 3px solid transparent;
    }
    .log-entry.info {
      border-left-color: #2196F3;
    }
    .log-entry.success {
      border-left-color: #4CAF50;
    }
    .log-entry.warning {
      border-left-color: #FF9800;
    }
    .log-entry.error {
      border-left-color: #f44336;
    }
    .metric {
      display: inline-block;
      margin: 10px 20px 10px 0;
      padding: 10px 20px;
      background: #e3f2fd;
      border-radius: 4px;
    }
    .metric-label {
      font-size: 12px;
      color: #666;
      text-transform: uppercase;
    }
    .metric-value {
      font-size: 24px;
      font-weight: bold;
      color: #2196F3;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Incognito Mode</h1>
    
    <div class="test-section">
      <h2>üìã ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö</h2>
      <div id="test-status">
        <span class="status pending">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö...</span>
      </div>
      <button onclick="runAllTests()">‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö</button>
      <button onclick="clearLogs()">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏•‡πá‡∏≠‡∏Å</button>
    </div>

    <div class="test-section">
      <h2>üìä ‡πÄ‡∏°‡∏ï‡∏£‡∏¥‡∏Å</h2>
      <div id="metrics">
        <div class="metric">
          <div class="metric-label">Token Refresh</div>
          <div class="metric-value" id="token-refresh-count">0</div>
        </div>
        <div class="metric">
          <div class="metric-label">Duplicate Elements</div>
          <div class="metric-value" id="duplicate-count">0</div>
        </div>
        <div class="metric">
          <div class="metric-label">Errors</div>
          <div class="metric-value" id="error-count">0</div>
        </div>
      </div>
    </div>

    <div class="test-section">
      <h2>üìù ‡∏•‡πá‡∏≠‡∏Å</h2>
      <div id="log" class="log"></div>
    </div>

    <div class="test-section">
      <h2>üîç ‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡πà‡∏ß‡∏ô</h2>
      <button onclick="testDuplicateElements()">1Ô∏è‚É£ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Duplicate Elements</button>
      <button onclick="testTokenRefresh()">2Ô∏è‚É£ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Token Refresh</button>
      <button onclick="testEquipmentPage()">3Ô∏è‚É£ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</button>
      <button onclick="testFirebaseConnection()">4Ô∏è‚É£ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Firebase</button>
    </div>

    <div class="test-section">
      <h2>‚ÑπÔ∏è ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</h2>
      <ul>
        <li>‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ô <strong>Incognito/Private Mode</strong></li>
        <li>‡πÄ‡∏õ‡∏¥‡∏î Developer Console (F12) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</li>
        <li>‡∏Ñ‡∏•‡∏¥‡∏Å "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</li>
        <li>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏°‡∏ï‡∏£‡∏¥‡∏Å‡πÅ‡∏•‡∏∞‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤‡∏õ‡∏±‡∏ç‡∏´‡∏≤</li>
      </ul>
    </div>
  </div>

  <script>
    let tokenRefreshCount = 0;
    let errorCount = 0;
    let duplicateCount = 0;
    let lastTokenRefreshTime = Date.now();

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      
      const timestamp = new Date().toLocaleTimeString('th-TH');
      const icon = {
        info: '‚ÑπÔ∏è',
        success: '‚úÖ',
        warning: '‚ö†Ô∏è',
        error: '‚ùå'
      }[type] || '‚ÑπÔ∏è';
      
      entry.textContent = `[${timestamp}] ${icon} ${message}`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
      
      console.log(`[${type.toUpperCase()}] ${message}`);
    }

    function updateMetric(id, value) {
      const element = document.getElementById(id);
      if (element) {
        element.textContent = value;
      }
    }

    function updateStatus(status, type) {
      const statusDiv = document.getElementById('test-status');
      statusDiv.innerHTML = `<span class="status ${type}">${status}</span>`;
    }

    function clearLogs() {
      document.getElementById('log').innerHTML = '';
      log('‡∏•‡πá‡∏≠‡∏Å‡∏ñ‡∏π‡∏Å‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß', 'info');
    }

    function testDuplicateElements() {
      log('üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Duplicate Elements...', 'info');
      
      const navbars = document.querySelectorAll('nav');
      const sidebars = document.querySelectorAll('[role="navigation"]');
      const headers = document.querySelectorAll('header');
      
      duplicateCount = 0;
      
      if (navbars.length > 1) {
        duplicateCount++;
        log(`‡∏û‡∏ö Navbar ‡∏ã‡πâ‡∏≥: ${navbars.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'warning');
      } else {
        log(`Navbar: ${navbars.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏õ‡∏Å‡∏ï‡∏¥)`, 'success');
      }
      
      if (sidebars.length > 1) {
        duplicateCount++;
        log(`‡∏û‡∏ö Sidebar ‡∏ã‡πâ‡∏≥: ${sidebars.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'warning');
      } else {
        log(`Sidebar: ${sidebars.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏õ‡∏Å‡∏ï‡∏¥)`, 'success');
      }
      
      if (headers.length > 1) {
        duplicateCount++;
        log(`‡∏û‡∏ö Header ‡∏ã‡πâ‡∏≥: ${headers.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'warning');
      } else {
        log(`Header: ${headers.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏õ‡∏Å‡∏ï‡∏¥)`, 'success');
      }
      
      updateMetric('duplicate-count', duplicateCount);
      
      if (duplicateCount === 0) {
        log('‚úÖ ‡πÑ‡∏°‡πà‡∏û‡∏ö Duplicate Elements', 'success');
        return true;
      } else {
        log(`‚ùå ‡∏û‡∏ö Duplicate Elements ${duplicateCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'error');
        errorCount++;
        updateMetric('error-count', errorCount);
        return false;
      }
    }

    function testTokenRefresh() {
      log('üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Token Refresh...', 'info');
      
      // Monitor console for token refresh messages
      const originalLog = console.log;
      console.log = function(...args) {
        const message = args.join(' ');
        
        if (message.includes('Token changed') || message.includes('Token refresh') || message.includes('üîÑ')) {
          tokenRefreshCount++;
          const now = Date.now();
          const timeSinceLastRefresh = now - lastTokenRefreshTime;
          
          updateMetric('token-refresh-count', tokenRefreshCount);
          
          if (timeSinceLastRefresh < 1000) {
            log(`‚ö†Ô∏è Token refresh ‡∏ñ‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ! (${timeSinceLastRefresh}ms)`, 'warning');
            errorCount++;
            updateMetric('error-count', errorCount);
          } else {
            log(`Token refresh #${tokenRefreshCount} (${timeSinceLastRefresh}ms)`, 'info');
          }
          
          lastTokenRefreshTime = now;
        }
        
        originalLog.apply(console, args);
      };
      
      log('‚úÖ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Token Refresh (‡∏î‡∏π‡∏ó‡∏µ‡πà Console)', 'success');
      return true;
    }

    function testEquipmentPage() {
      log('üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå...', 'info');
      
      // Check if we're on equipment page
      const isEquipmentPage = window.location.pathname.includes('/equipment');
      
      if (isEquipmentPage) {
        log('‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå', 'info');
        
        // Check for error messages
        const errorMessages = document.querySelectorAll('[class*="error"], [class*="Error"]');
        if (errorMessages.length > 0) {
          log(`‚ùå ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° error ${errorMessages.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'error');
          errorCount++;
          updateMetric('error-count', errorCount);
          return false;
        }
        
        // Check for loading state
        const loadingElements = document.querySelectorAll('[class*="loading"], [class*="Loading"]');
        if (loadingElements.length > 0) {
          log(`‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î... (${loadingElements.length} elements)`, 'warning');
        }
        
        log('‚úÖ ‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥', 'success');
        return true;
      } else {
        log('‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå', 'warning');
        return false;
      }
    }

    function testFirebaseConnection() {
      log('üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö Firebase Connection...', 'info');
      
      // Check for Firebase errors in console
      const hasFirebaseError = window.performance
        .getEntriesByType('resource')
        .some(entry => entry.name.includes('firebase') && entry.responseStatus >= 400);
      
      if (hasFirebaseError) {
        log('‚ùå ‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase', 'error');
        errorCount++;
        updateMetric('error-count', errorCount);
        return false;
      }
      
      log('‚úÖ Firebase Connection ‡∏õ‡∏Å‡∏ï‡∏¥', 'success');
      return true;
    }

    async function runAllTests() {
      log('üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î...', 'info');
      updateStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö...', 'pending');
      
      // Reset counters
      tokenRefreshCount = 0;
      errorCount = 0;
      duplicateCount = 0;
      updateMetric('token-refresh-count', 0);
      updateMetric('duplicate-count', 0);
      updateMetric('error-count', 0);
      
      const results = [];
      
      // Run tests
      results.push(testDuplicateElements());
      results.push(testTokenRefresh());
      results.push(testEquipmentPage());
      results.push(testFirebaseConnection());
      
      // Wait a bit for async operations
      await new Promise(resolve => setTimeout(resolve, 2000));
      
      // Summary
      const allPassed = results.every(r => r === true);
      
      if (allPassed) {
        log('‚úÖ ‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ú‡πà‡∏≤‡∏ô!', 'success');
        updateStatus('‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‚úÖ', 'pass');
      } else {
        log('‚ùå ‡∏°‡∏µ‡∏ö‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô', 'error');
        updateStatus('‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‚ùå', 'fail');
      }
      
      log(`üìä ‡∏™‡∏£‡∏∏‡∏õ: ${results.filter(r => r).length}/${results.length} ‡∏ú‡πà‡∏≤‡∏ô`, 'info');
    }

    // Auto-run on load
    window.addEventListener('load', () => {
      log('üéØ ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'success');
      log('‡∏Ñ‡∏•‡∏¥‡∏Å "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö', 'info');
    });

    // Monitor errors
    window.addEventListener('error', (event) => {
      log(`‚ùå JavaScript Error: ${event.message}`, 'error');
      errorCount++;
      updateMetric('error-count', errorCount);
    });

    // Monitor unhandled promise rejections
    window.addEventListener('unhandledrejection', (event) => {
      log(`‚ùå Unhandled Promise Rejection: ${event.reason}`, 'error');
      errorCount++;
      updateMetric('error-count', errorCount);
    });
  </script>
</body>
</html>
