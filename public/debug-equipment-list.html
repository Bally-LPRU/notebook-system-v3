<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Debug Equipment List</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1000px;
      margin: 20px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 20px;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #45a049;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    #results {
      background: #f9f9f9;
      padding: 15px;
      border-radius: 4px;
      border-left: 4px solid #4CAF50;
      white-space: pre-wrap;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
      max-height: 600px;
      overflow-y: auto;
    }
    .loading {
      color: #666;
      font-style: italic;
    }
    .error {
      color: #d32f2f;
      border-left-color: #d32f2f;
    }
    .success {
      color: #2e7d32;
    }
    .warning {
      color: #f57c00;
    }
    .info {
      background: #e3f2fd;
      border-left-color: #2196F3;
      color: #1565c0;
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç Debug Equipment List</h1>
    <div>
      <button onclick="testSimpleQuery()">1. ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Query ‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤</button>
      <button onclick="testWithFilters()">2. ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Query + Filters</button>
      <button onclick="testPermissions()">3. ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Permissions</button>
      <button onclick="checkAuth()">4. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Auth Status</button>
    </div>
    <div id="results" class="loading">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö</div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { 
      getAuth,
      onAuthStateChanged,
      signInWithPopup,
      GoogleAuthProvider
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { 
      getFirestore, 
      collection, 
      getDocs,
      query,
      where,
      orderBy,
      limit
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // ‚ö†Ô∏è ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢ Firebase config ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "equipment-lending-system-41b49.firebaseapp.com",
      projectId: "equipment-lending-system-41b49",
      storageBucket: "equipment-lending-system-41b49.firebasestorage.app",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let currentUser = null;

    // Monitor auth state
    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      if (user) {
        console.log('‚úÖ User logged in:', user.email);
      } else {
        console.log('‚ùå No user logged in');
      }
    });

    function log(message, type = 'info') {
      const resultsDiv = document.getElementById('results');
      resultsDiv.className = type;
      resultsDiv.textContent += message + '\n';
      console.log(message);
    }

    function clearLog() {
      const resultsDiv = document.getElementById('results');
      resultsDiv.textContent = '';
      resultsDiv.className = '';
    }

    window.checkAuth = async function() {
      clearLog();
      log('üîê ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...\n');

      if (currentUser) {
        log(`‚úÖ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß`);
        log(`   Email: ${currentUser.email}`);
        log(`   UID: ${currentUser.uid}`);
        log(`   Display Name: ${currentUser.displayName || '‡πÑ‡∏°‡πà‡∏°‡∏µ'}\n`);

        // Get ID token
        try {
          const token = await currentUser.getIdToken();
          const tokenResult = await currentUser.getIdTokenResult();
          log(`üìù Token Info:`);
          log(`   Claims: ${JSON.stringify(tokenResult.claims, null, 2)}\n`);
        } catch (error) {
          log(`‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á token ‡πÑ‡∏î‡πâ: ${error.message}`, 'error');
        }
      } else {
        log('‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö', 'warning');
        log('\nüí° ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö\n');
        
        const loginBtn = document.createElement('button');
        loginBtn.textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Google';
        loginBtn.onclick = async () => {
          try {
            const provider = new GoogleAuthProvider();
            await signInWithPopup(auth, provider);
            log('‚úÖ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
            setTimeout(() => checkAuth(), 1000);
          } catch (error) {
            log(`‚ùå ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}`, 'error');
          }
        };
        document.getElementById('results').appendChild(loginBtn);
      }
    };

    window.testSimpleQuery = async function() {
      clearLog();
      log('üì¶ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Query ‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ (equipmentManagement)\n');

      try {
        log('1Ô∏è‚É£ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î...');
        const equipmentRef = collection(db, 'equipmentManagement');
        const snapshot = await getDocs(equipmentRef);
        
        log(`‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏û‡∏ö ${snapshot.size} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£\n`);

        if (snapshot.empty) {
          log('‚ö†Ô∏è  Collection ‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤', 'warning');
        } else {
          log('üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå:');
          snapshot.forEach((doc, index) => {
            const data = doc.data();
            log(`\n${index + 1}. ID: ${doc.id}`);
            log(`   ‡∏ä‡∏∑‡πà‡∏≠: ${data.name || '‡πÑ‡∏°‡πà‡∏°‡∏µ'}`);
            log(`   ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç: ${data.equipmentNumber || '‡πÑ‡∏°‡πà‡∏°‡∏µ'}`);
            log(`   ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${data.status || '‡πÑ‡∏°‡πà‡∏°‡∏µ'}`);
            log(`   isActive: ${data.isActive}`);
            log(`   Category: ${JSON.stringify(data.category)}`);
          });
        }

      } catch (error) {
        log(`\n‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:`, 'error');
        log(`   Code: ${error.code}`);
        log(`   Message: ${error.message}`);
        log(`   Stack: ${error.stack}`);
      }
    };

    window.testWithFilters = async function() {
      clearLog();
      log('üîç ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Query + Filters\n');

      try {
        log('1Ô∏è‚É£ Query: isActive == true + orderBy updatedAt');
        const equipmentRef = collection(db, 'equipmentManagement');
        const q = query(
          equipmentRef,
          where('isActive', '==', true),
          orderBy('updatedAt', 'desc'),
          limit(10)
        );
        
        const snapshot = await getDocs(q);
        log(`‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏û‡∏ö ${snapshot.size} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£\n`);

        if (snapshot.empty) {
          log('‚ö†Ô∏è  ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç', 'warning');
          log('\nüí° ‡∏•‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö:');
          log('   - ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà isActive = true ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?');
          log('   - ‡∏°‡∏µ field updatedAt ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?');
          log('   - ‡∏°‡∏µ index ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö query ‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?');
        } else {
          log('üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà active:');
          snapshot.forEach((doc, index) => {
            const data = doc.data();
            log(`\n${index + 1}. ${data.name || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠'}`);
            log(`   ID: ${doc.id}`);
            log(`   Status: ${data.status}`);
            log(`   Updated: ${data.updatedAt?.toDate?.() || '‡πÑ‡∏°‡πà‡∏°‡∏µ'}`);
          });
        }

      } catch (error) {
        log(`\n‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:`, 'error');
        log(`   Code: ${error.code}`);
        log(`   Message: ${error.message}`);
        
        if (error.code === 'failed-precondition') {
          log('\nüí° ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Index:');
          log('   Collection: equipmentManagement');
          log('   Fields: isActive (ASC), updatedAt (DESC)');
        }
      }
    };

    window.testPermissions = async function() {
      clearLog();
      log('üîê ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Permissions\n');

      if (!currentUser) {
        log('‚ùå ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô', 'error');
        return;
      }

      try {
        log('1Ô∏è‚É£ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• users...');
        const userDoc = await getDocs(query(collection(db, 'users'), where('uid', '==', currentUser.uid)));
        if (!userDoc.empty) {
          const userData = userDoc.docs[0].data();
          log(`‚úÖ ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ`);
          log(`   Role: ${userData.role}`);
          log(`   Status: ${userData.status}\n`);
        } else {
          log(`‚ö†Ô∏è  ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• user\n`, 'warning');
        }

        log('2Ô∏è‚É£ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• equipmentManagement...');
        const equipmentSnapshot = await getDocs(query(collection(db, 'equipmentManagement'), limit(1)));
        log(`‚úÖ ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ (${equipmentSnapshot.size} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)\n`);

      } catch (error) {
        log(`\n‚ùå Permission denied:`, 'error');
        log(`   ${error.message}`);
      }
    };
  </script>
</body>
</html>
