<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Equipment</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 900px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      border-bottom: 3px solid #4CAF50;
      padding-bottom: 10px;
    }
    .status {
      padding: 15px;
      margin: 15px 0;
      border-radius: 5px;
      font-weight: bold;
    }
    .info { background: #E3F2FD; color: #1976D2; }
    .success { background: #E8F5E9; color: #388E3C; }
    .error { background: #FFEBEE; color: #C62828; }
    .warning { background: #FFF3E0; color: #F57C00; }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 12px 30px;
      font-size: 16px;
      border-radius: 5px;
      cursor: pointer;
      margin: 10px 5px;
    }
    button:hover { background: #45a049; }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    #log {
      background: #f9f9f9;
      border: 1px solid #ddd;
      padding: 15px;
      margin-top: 20px;
      border-radius: 5px;
      max-height: 400px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      white-space: pre-wrap;
    }
    .log-item {
      margin: 5px 0;
      padding: 5px;
    }
    .log-success { color: #388E3C; }
    .log-error { color: #C62828; }
    .log-info { color: #1976D2; }
    .summary {
      background: #f0f0f0;
      padding: 15px;
      margin-top: 20px;
      border-radius: 5px;
      border-left: 4px solid #4CAF50;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîß ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Equipment Management</h1>
    
    <div id="loginSection">
      <div class="status warning">
        <strong>‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á Login ‡∏Å‡πà‡∏≠‡∏ô:</strong><br>
        ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á login ‡∏î‡πâ‡∏ß‡∏¢‡∏ö‡∏±‡∏ç‡∏ä‡∏µ Admin ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      </div>
      <div>
        <button onclick="loginWithGoogle()">üîê Login ‡∏î‡πâ‡∏ß‡∏¢ Google</button>
      </div>
      <div id="userInfo" style="display: none; margin-top: 15px; padding: 10px; background: #E8F5E9; border-radius: 5px;">
        <strong>üë§ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:</strong> <span id="userName"></span><br>
        <strong>üìß ‡∏≠‡∏µ‡πÄ‡∏°‡∏•:</strong> <span id="userEmail"></span><br>
        <strong>üé≠ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> <span id="userRole"></span>
      </div>
    </div>

    <div id="mainSection" style="display: none;">
      <div class="status info">
        <strong>‚ÑπÔ∏è ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</strong><br>
        1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç<br>
        2. ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î<br>
        3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÉ‡∏ô log ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
      </div>

      <div>
        <button id="validateBtn" onclick="validateData()">üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        <button id="fixBtn" onclick="fixData()" disabled>üîß ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        <button id="validateAfterBtn" onclick="validateData()" disabled>‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
      </div>
    </div>

    <div id="log"></div>
    <div id="summary" class="summary" style="display: none;"></div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
    import { getFirestore, collection, getDocs, doc, updateDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
    import { getAuth, signInWithPopup, GoogleAuthProvider } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';

    const firebaseConfig = {
      apiKey: "AIzaSyA9D6ReIlhiaaJ1g1Obd-dcjp2R0LO_eyo",
      authDomain: "equipment-lending-system-41b49.firebaseapp.com",
      projectId: "equipment-lending-system-41b49",
      storageBucket: "equipment-lending-system-41b49.firebasestorage.app",
      messagingSenderId: "47770598089",
      appId: "1:47770598089:web:9d898f247f742fe1686b18"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const googleProvider = new GoogleAuthProvider();

    let currentUser = null;

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ login
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        currentUser = user;
        document.getElementById('userName').textContent = user.displayName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
        document.getElementById('userEmail').textContent = user.email;
        document.getElementById('userRole').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...';
        document.getElementById('userInfo').style.display = 'block';
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô admin ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        try {
          const userDoc = await getDocs(collection(db, 'users'));
          const userData = userDoc.docs.find(d => d.id === user.uid)?.data();
          if (userData && userData.role === 'admin') {
            document.getElementById('userRole').textContent = '‚úÖ Admin';
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('mainSection').style.display = 'block';
          } else {
            document.getElementById('userRole').textContent = '‚ùå ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Admin';
            alert('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
          }
        } catch (error) {
          console.error('Error checking user role:', error);
          document.getElementById('userRole').textContent = '‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏î‡πâ';
        }
      } else {
        currentUser = null;
        document.getElementById('loginSection').style.display = 'block';
        document.getElementById('mainSection').style.display = 'none';
        document.getElementById('userInfo').style.display = 'none';
      }
    });

    window.loginWithGoogle = async function() {
      try {
        await signInWithPopup(auth, googleProvider);
      } catch (error) {
        alert('Login ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + error.message);
        console.error(error);
      }
    };

    const STATUS_MAPPING = {
      'available': 'active',
      'in_use': 'active',
      'unavailable': 'maintenance',
      'broken': 'maintenance',
      'retired': 'retired',
      'lost': 'lost'
    };

    const VALID_STATUSES = ['active', 'maintenance', 'retired', 'lost'];

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const logItem = document.createElement('div');
      logItem.className = `log-item log-${type}`;
      logItem.textContent = message;
      logDiv.appendChild(logItem);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function clearLog() {
      document.getElementById('log').innerHTML = '';
      document.getElementById('summary').style.display = 'none';
    }

    window.validateData = async function() {
      if (!currentUser) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ login ‡∏Å‡πà‡∏≠‡∏ô');
        return;
      }

      clearLog();
      log('üîç ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', 'info');
      
      try {
        const querySnapshot = await getDocs(collection(db, 'equipmentManagement'));
        
        if (querySnapshot.empty) {
          log('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô collection equipmentManagement', 'error');
          return;
        }

        log(`üìä ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${querySnapshot.size} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£\n`, 'info');

        let validCount = 0;
        let invalidCount = 0;
        const issues = [];

        querySnapshot.forEach((docSnapshot) => {
          const data = docSnapshot.data();
          const docIssues = [];
          
          log(`\nüìÑ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö: ${data.name || docSnapshot.id}`, 'info');

          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö required fields
          if (!data.equipmentNumber) docIssues.push('‡∏Ç‡∏≤‡∏î equipmentNumber');
          if (!data.name) docIssues.push('‡∏Ç‡∏≤‡∏î name');
          if (!data.category || !data.category.id || !data.category.name) {
            docIssues.push('category ‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå');
          }
          if (!VALID_STATUSES.includes(data.status)) {
            docIssues.push(`status ‡∏ú‡∏¥‡∏î: ${data.status}`);
          }
          if (!data.location || typeof data.location !== 'object') {
            docIssues.push('‡∏Ç‡∏≤‡∏î location');
          }
          if (!data.responsiblePerson || !data.responsiblePerson.uid) {
            docIssues.push('‡∏Ç‡∏≤‡∏î responsiblePerson');
          }
          if (!Array.isArray(data.images)) docIssues.push('images ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà array');
          if (!Array.isArray(data.tags)) docIssues.push('tags ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà array');
          if (!Array.isArray(data.searchKeywords)) docIssues.push('searchKeywords ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà array');

          if (docIssues.length === 0) {
            log('   ‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'success');
            validCount++;
          } else {
            log('   ‚ö†Ô∏è ‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤: ' + docIssues.join(', '), 'error');
            invalidCount++;
            issues.push({ id: docSnapshot.id, name: data.name, issues: docIssues });
          }
        });

        // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏£‡∏∏‡∏õ
        const summaryDiv = document.getElementById('summary');
        summaryDiv.style.display = 'block';
        summaryDiv.innerHTML = `
          <strong>üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö:</strong><br>
          ‚úÖ ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: ${validCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£<br>
          ‚ö†Ô∏è ‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤: ${invalidCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
        `;

        if (invalidCount > 0) {
          log('\nüí° ‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç', 'warning');
          document.getElementById('fixBtn').disabled = false;
        } else {
          log('\n‚ú® ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!', 'success');
        }

      } catch (error) {
        log(`‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`, 'error');
        console.error(error);
      }
    };

    window.fixData = async function() {
      if (!currentUser) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ login ‡∏Å‡πà‡∏≠‡∏ô');
        return;
      }

      if (!confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•?')) {
        return;
      }

      clearLog();
      log('üîß ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', 'info');
      document.getElementById('fixBtn').disabled = true;

      try {
        const querySnapshot = await getDocs(collection(db, 'equipmentManagement'));
        
        if (querySnapshot.empty) {
          log('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô collection equipmentManagement', 'error');
          return;
        }

        log(`üìä ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${querySnapshot.size} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£\n`, 'info');

        let successCount = 0;
        let errorCount = 0;

        for (const docSnapshot of querySnapshot.docs) {
          try {
            const data = docSnapshot.data();
            log(`\nüîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ${data.name || docSnapshot.id}`, 'info');

            // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏° createdAt, createdBy, equipmentNumber)
            const fixedData = {
              name: data.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠',
              category: {
                id: data.category?.id || 'computers',
                name: data.category?.name || '‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå',
                icon: data.category?.icon || 'üíª'
              },
              brand: data.brand || '',
              model: data.model || '',
              description: data.description || '',
              specifications: data.specifications || {},
              status: STATUS_MAPPING[data.status] || 'active',
              location: data.location || {
                building: '',
                floor: '',
                room: '',
                description: ''
              },
              purchaseDate: data.purchaseDate || null,
              purchasePrice: data.purchasePrice || 0,
              vendor: data.vendor || '',
              warrantyExpiry: data.warrantyExpiry || null,
              responsiblePerson: data.responsiblePerson || {
                uid: currentUser.uid,
                name: currentUser.displayName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
                email: currentUser.email || '',
                department: ''
              },
              images: Array.isArray(data.images) ? data.images : [],
              qrCode: data.qrCode || null,
              tags: Array.isArray(data.tags) ? data.tags : [],
              searchKeywords: Array.isArray(data.searchKeywords) 
                ? data.searchKeywords 
                : [
                    data.equipmentNumber?.toLowerCase() || '',
                    data.name?.toLowerCase() || ''
                  ].filter(Boolean),
              notes: data.notes || '',
              updatedAt: serverTimestamp(),
              updatedBy: currentUser.uid,  // ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô current user
              version: (data.version || 0) + 1,
              isActive: data.isActive !== false,
              viewCount: data.viewCount || 0,
              lastViewed: data.lastViewed || null
            };

            const docRef = doc(db, 'equipmentManagement', docSnapshot.id);
            await updateDoc(docRef, fixedData);
            
            log(`   ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à - Status: ${data.status} ‚Üí ${fixedData.status}`, 'success');
            successCount++;
          } catch (error) {
            log(`   ‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`, 'error');
            errorCount++;
          }
        }

        const summaryDiv = document.getElementById('summary');
        summaryDiv.style.display = 'block';
        summaryDiv.innerHTML = `
          <strong>üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:</strong><br>
          ‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${successCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£<br>
          ‚ùå ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${errorCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
        `;

        if (successCount > 0) {
          log('\n‚ú® ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß', 'success');
          document.getElementById('validateAfterBtn').disabled = false;
        }

      } catch (error) {
        log(`‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`, 'error');
        console.error(error);
      }
    };
  </script>
</body>
</html>
