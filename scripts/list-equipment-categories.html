<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Equipment Categories</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }
        .status {
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .loading {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .category-card {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid #4CAF50;
        }
        .category-id {
            font-weight: bold;
            color: #2196F3;
            font-size: 1.1em;
        }
        .category-name {
            font-size: 1.2em;
            margin: 5px 0;
        }
        .category-info {
            color: #666;
            font-size: 0.9em;
        }
        .stats {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .create-form {
            background: #fff3cd;
            padding: 20px;
            border-radius: 4px;
            margin: 20px 0;
            display: none;
        }
        .create-form.show {
            display: block;
        }
        input, textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Equipment Categories</h1>
        
        <div id="status" class="status loading">
            ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
        </div>

        <button onclick="loadCategories()">üîÑ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà</button>
        <button onclick="toggleCreateForm()">‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á Category ‡πÉ‡∏´‡∏°‡πà</button>

        <div id="createForm" class="create-form">
            <h3>‡∏™‡∏£‡πâ‡∏≤‡∏á Category ‡πÉ‡∏´‡∏°‡πà</h3>
            <label>Category ID (‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©, ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á):</label>
            <input type="text" id="categoryId" placeholder="‡πÄ‡∏ä‡πà‡∏ô laptop, projector, camera">
            
            <label>‡∏ä‡∏∑‡πà‡∏≠ Category (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢):</label>
            <input type="text" id="categoryName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÇ‡∏ô‡πâ‡∏ï‡∏ö‡∏∏‡πä‡∏Å">
            
            <label>‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:</label>
            <textarea id="categoryDescription" rows="3" placeholder="‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö category ‡∏ô‡∏µ‡πâ"></textarea>
            
            <button onclick="createCategory()">‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á Category</button>
            <button onclick="toggleCreateForm()">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>

        <div id="stats" class="stats" style="display:none;">
            <h3>üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</h3>
            <div id="statsContent"></div>
        </div>

        <div id="categories"></div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs, doc, setDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA9D6ReIlhiaaJ1g1Obd-dcjp2R0LO_eyo",
            authDomain: "equipment-lending-system-41b49.firebaseapp.com",
            projectId: "equipment-lending-system-41b49",
            storageBucket: "equipment-lending-system-41b49.firebasestorage.app",
            messagingSenderId: "47770598089",
            appId: "1:47770598089:web:9d898f247f742fe1686b18"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Make functions global
        window.loadCategories = loadCategories;
        window.toggleCreateForm = toggleCreateForm;
        window.createCategory = createCategory;

        // Auto-login with Google
        async function ensureAuth() {
            if (!auth.currentUser) {
                const provider = new GoogleAuthProvider();
                try {
                    await signInWithPopup(auth, provider);
                    console.log('‚úÖ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                } catch (error) {
                    console.error('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ:', error);
                    throw error;
                }
            }
        }

        async function loadCategories() {
            const statusDiv = document.getElementById('status');
            const categoriesDiv = document.getElementById('categories');
            const statsDiv = document.getElementById('stats');
            const statsContent = document.getElementById('statsContent');

            try {
                await ensureAuth();
                
                statusDiv.className = 'status loading';
                statusDiv.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
                categoriesDiv.innerHTML = '';

                const snapshot = await getDocs(collection(db, 'equipmentCategories'));

                if (snapshot.empty) {
                    statusDiv.className = 'status error';
                    statusDiv.innerHTML = `
                        ‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• equipmentCategories ‡πÉ‡∏ô Firestore<br>
                        üí° ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏™‡∏£‡πâ‡∏≤‡∏á Category ‡πÉ‡∏´‡∏°‡πà" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    `;
                    statsDiv.style.display = 'none';
                    return;
                }

                statusDiv.className = 'status success';
                statusDiv.textContent = `‚úÖ ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• equipmentCategories ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${snapshot.size} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;

                const categories = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    categories.push({
                        id: doc.id,
                        ...data
                    });
                });

                // Display categories
                categories.forEach(cat => {
                    const card = document.createElement('div');
                    card.className = 'category-card';
                    card.innerHTML = `
                        <div class="category-id">üì¶ ID: ${cat.id}</div>
                        <div class="category-name">${cat.name || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠'}</div>
                        ${cat.description ? `<div class="category-info">üìù ${cat.description}</div>` : ''}
                        <div class="category-info">üìä ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå: ${cat.equipmentCount || 0}</div>
                        ${cat.createdAt ? `<div class="category-info">üïê ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date(cat.createdAt.seconds * 1000).toLocaleString('th-TH')}</div>` : ''}
                    `;
                    categoriesDiv.appendChild(card);
                });

                // Display stats
                const totalEquipment = categories.reduce((sum, cat) => sum + (cat.equipmentCount || 0), 0);
                statsContent.innerHTML = `
                    <p>üì¶ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Categories ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <strong>${categories.length}</strong> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                    <p>üîß ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <strong>${totalEquipment}</strong> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                `;
                statsDiv.style.display = 'block';

            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.innerHTML = `‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}<br>üí° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Google Account ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô Admin`;
                console.error(error);
            }
        }

        function toggleCreateForm() {
            const form = document.getElementById('createForm');
            form.classList.toggle('show');
        }

        async function createCategory() {
            const categoryId = document.getElementById('categoryId').value.trim().toLowerCase();
            const categoryName = document.getElementById('categoryName').value.trim();
            const categoryDescription = document.getElementById('categoryDescription').value.trim();

            if (!categoryId || !categoryName) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Category ID ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠ Category');
                return;
            }

            // Validate ID format
            if (!/^[a-z0-9-_]+$/.test(categoryId)) {
                alert('Category ID ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡πá‡∏Å ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‡πÅ‡∏•‡∏∞ - _ ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
                return;
            }

            try {
                await ensureAuth();

                const categoryRef = doc(db, 'equipmentCategories', categoryId);
                await setDoc(categoryRef, {
                    name: categoryName,
                    description: categoryDescription || '',
                    equipmentCount: 0,
                    createdAt: serverTimestamp(),
                    createdBy: auth.currentUser.uid,
                    updatedAt: serverTimestamp()
                });

                alert(`‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á Category "${categoryName}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`);
                
                // Clear form
                document.getElementById('categoryId').value = '';
                document.getElementById('categoryName').value = '';
                document.getElementById('categoryDescription').value = '';
                toggleCreateForm();
                
                // Reload categories
                loadCategories();

            } catch (error) {
                alert(`‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`);
                console.error(error);
            }
        }

        // Load categories on page load
        loadCategories();
    </script>
</body>
</html>
